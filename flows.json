[{"id":"8f8f43f7.01481","type":"tab","label":"Dashboard","disabled":false,"info":""},{"id":"960d5a8b.8e7398","type":"tab","label":"Water","disabled":false,"info":""},{"id":"865fb592.2877c8","type":"mqtt-broker","z":"","name":"localhost-mosquitto","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"326bb2da.30ab9e","type":"ui_tab","z":"","name":"Tab1","icon":"dashboard","disabled":false,"hidden":false},{"id":"cfef9cf7.e793b","type":"ui_group","z":"","name":"Water Monitoring","tab":"326bb2da.30ab9e","disp":true,"width":"6","collapse":false},{"id":"bfdade84.fd41d","type":"ui_base","theme":{"name":"theme-custom","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","reset":false},"themeState":{"base-color":{"default":"#4B7930","value":"#4B7930","edited":false},"page-titlebar-backgroundColor":{"value":"#4B7930","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#000000","edited":false},"group-textColor":{"value":"#6db046","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#4b7930","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"true","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"8a457ff5.55c5e","type":"ui_tab","z":"","name":"Water","icon":"dashboard","disabled":false,"hidden":false},{"id":"52e438cf.a42268","type":"ui_group","z":"","name":"Water options","tab":"8a457ff5.55c5e","disp":true,"width":"6","collapse":false},{"id":"5c87f508.f134ec","type":"ui_group","z":"","name":"Custom Widget","tab":"326bb2da.30ab9e","disp":true,"width":"6","collapse":false},{"id":"d159396.8c5adc8","type":"mongodb","z":"","hostname":"127.0.0.1","port":"27017","db":"water","name":""},{"id":"f8c4a64c.43daf8","type":"inject","z":"8f8f43f7.01481","name":"","topic":"water","payload":"","payloadType":"str","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":60,"wires":[["c7f2f80d.b71498"]]},{"id":"3989bd20.f78b52","type":"uibuilder","z":"8f8f43f7.01481","name":"react_ui","topic":"","url":"react_ui","fwdInMessages":false,"allowScripts":false,"allowStyles":false,"debugFE":false,"copyIndex":false,"template":"","x":500,"y":140,"wires":[[],[]]},{"id":"c7f2f80d.b71498","type":"function","z":"8f8f43f7.01481","name":"Random","func":"rnd = (Math.random() * 3).toFixed(1);\nmsg.payload = rnd;\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":60,"wires":[[]]},{"id":"e83a242c.9a01e8","type":"debug","z":"8f8f43f7.01481","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":500,"y":220,"wires":[]},{"id":"24dc4c67.4103f4","type":"mqtt out","z":"960d5a8b.8e7398","name":"","topic":"water_monitor/valve_control","qos":"","retain":"","broker":"865fb592.2877c8","x":880,"y":340,"wires":[]},{"id":"77cec268.a1011c","type":"mqtt out","z":"960d5a8b.8e7398","name":"","topic":"water_monitor/config","qos":"","retain":"","broker":"865fb592.2877c8","x":880,"y":520,"wires":[]},{"id":"992ceb5.f73f818","type":"mqtt out","z":"960d5a8b.8e7398","name":"","topic":"water_monitor/status_request","qos":"","retain":"","broker":"865fb592.2877c8","x":910,"y":460,"wires":[]},{"id":"a6b4052d.83f7c8","type":"ui_button","z":"960d5a8b.8e7398","name":"","group":"cfef9cf7.e793b","order":4,"width":0,"height":0,"passthru":false,"label":"{{msg.payload}}","tooltip":"","color":"","bgcolor":"","icon":"","payload":"button_cmd","payloadType":"flow","topic":"","x":690,"y":340,"wires":[["24dc4c67.4103f4"]]},{"id":"641f97bc.a21fe8","type":"function","z":"960d5a8b.8e7398","name":"set button text","func":"var newMsg;\nif (msg.payload == \"open\"){\n    flow.set(\"button_cmd\", \"close\");\n    newMsg = { payload: \"close\", \n                enabled: true };\n} else if (msg.payload == \"closed\"){\n    flow.set(\"button_cmd\", \"open\");\n    newMsg = { payload: \"open\",\n                enabled: true };\n} else if (msg.payload == \"closing\") {\n    flow.set(\"button_cmd\", \"open\");\n    newMsg = { payload: \"open\",\n                enabled: true };\n} else if (msg.payload == \"opening\") {\n    flow.set(\"button_cmd\", \"close\");\n    newMsg = { payload: \"close\",\n                enabled: true };\n}\nreturn newMsg;","outputs":1,"noerr":0,"x":541,"y":340,"wires":[["a6b4052d.83f7c8"]]},{"id":"f9323c77.3a6d1","type":"switch","z":"960d5a8b.8e7398","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"water_monitor/flow_meter","vt":"str"},{"t":"eq","v":"water_monitor/valve_status","vt":"str"},{"t":"eq","v":"water_monitor/config_status","vt":"str"}],"checkall":"false","repair":false,"outputs":3,"x":350,"y":260,"wires":[["c20474e8.af24b8"],["641f97bc.a21fe8"],[]]},{"id":"ad492a61.1c54d8","type":"mqtt in","z":"960d5a8b.8e7398","name":"","topic":"water_monitor/#","qos":"0","datatype":"auto","broker":"865fb592.2877c8","x":120,"y":260,"wires":[["e199f265.47ce6","f9323c77.3a6d1"]]},{"id":"80f459a9.9dd6f8","type":"inject","z":"960d5a8b.8e7398","name":"on startup","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":"0","x":130,"y":40,"wires":[["4123a6a8.b1dac8"]]},{"id":"922e897f.95aa08","type":"function","z":"960d5a8b.8e7398","name":"when reconnected","func":"if (msg.payload == \"no timeout\") {\n    flow.set(\"water_monitor_online\", true);\n    //var newMsg = { payload: flow.get(\"wm_config_payload\")};\n    return { payload: flow.get(\"wm_config_payload\")};\n} else if (msg.payload == \"timeout\") {\n    flow.set(\"water_monitor_online\", false);\n    return null;\n}","outputs":1,"noerr":0,"x":530,"y":520,"wires":[["77cec268.a1011c","422a397b.8809a8"]]},{"id":"4123a6a8.b1dac8","type":"function","z":"960d5a8b.8e7398","name":"set vars","func":"flow.set(\"reports_per_second\", 1);\nflow.set(\"wm_config_payload\", \"reports_per_second:\"+flow.get(\"reports_per_second\"));\n//return { payload: flow.get(\"wm_config_payload\") };","outputs":1,"noerr":0,"x":300,"y":40,"wires":[[]]},{"id":"e199f265.47ce6","type":"timeout","z":"960d5a8b.8e7398","name":"timeout","outtopic":"","outsafe":"no timeout","outwarning":"Warning","outunsafe":"timeout","warning":"0","timer":"5","repeat":false,"again":false,"x":300,"y":520,"wires":[["922e897f.95aa08"]]},{"id":"422a397b.8809a8","type":"change","z":"960d5a8b.8e7398","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"none","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":460,"wires":[["992ceb5.f73f818"]]},{"id":"9e917171.007cd","type":"link out","z":"960d5a8b.8e7398","name":"water daily","links":["19a0b940.f26c87"],"x":1230,"y":220,"wires":[],"l":true},{"id":"820ba66b.ca0938","type":"link in","z":"8f8f43f7.01481","name":"water flow","links":["e7a29659.12ef58"],"x":200,"y":140,"wires":[["3989bd20.f78b52"]],"l":true},{"id":"61ed5149.6b919","type":"mongodb out","z":"960d5a8b.8e7398","mongodb":"d159396.8c5adc8","name":"water->flow","collection":"flow","payonly":true,"upsert":false,"multi":false,"operation":"store","x":850,"y":220,"wires":[]},{"id":"c20474e8.af24b8","type":"function","z":"960d5a8b.8e7398","name":"filter out 0's","func":"if(msg.payload !== '0'){\n    return msg;\n}\nreturn null;","outputs":1,"noerr":0,"x":531,"y":200,"wires":[["c37b6b2d.9ce068","4decf75f.ca54c8","e7a29659.12ef58"]]},{"id":"c37b6b2d.9ce068","type":"function","z":"960d5a8b.8e7398","name":"create doc","func":"return {payload:{\n    value: msg.payload,\n    created_on: new Date()\n}};","outputs":1,"noerr":0,"x":690,"y":220,"wires":[["61ed5149.6b919"]]},{"id":"4decf75f.ca54c8","type":"function","z":"960d5a8b.8e7398","name":"create query","func":"flow.set(\"currentFlow\", Number(msg.payload))\nstart = new Date()\nend = new Date(start.valueOf())\nstart.setHours(0,0,0,0)\nend.setHours(24,0,0,0)\nreturn {payload:{created_on: {$gt: start, $lt:end}}}","outputs":1,"noerr":0,"x":690,"y":180,"wires":[["db982b0.78291d8"]]},{"id":"db982b0.78291d8","type":"mongodb in","z":"960d5a8b.8e7398","mongodb":"d159396.8c5adc8","name":"find in water->daily","collection":"daily","operation":"find","x":870,"y":180,"wires":[["20da2a30.ace936"]]},{"id":"5e51bd8d.486ec4","type":"inject","z":"960d5a8b.8e7398","name":"","topic":"water_monitor/flow_meter","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":200,"wires":[["f9323c77.3a6d1"]]},{"id":"20da2a30.ace936","type":"function","z":"960d5a8b.8e7398","name":"create daily doc","func":"var timestamp = new Date()\nvar curFlow = Number(flow.get(\"currentFlow\"))\nif(msg.payload.length === 0){\n    var doc = { \n        payload: {\n            value: curFlow,\n            created_on: timestamp,\n            modified: timestamp\n        }\n    }\n    return [doc, null, {payload: curFlow}]\n} else if (msg.payload.length === 1){\n    var todaysDaily = Number(msg.payload[0].value)+curFlow\n    var doc = {\n        query: {\n            _id: msg.payload[0]._id\n        },\n        payload: {\n            value: todaysDaily,\n            created_on: msg.payload[0].created_on,\n            modified: timestamp\n        }\n    }\n    return [null, doc, {payload: todaysDaily}]\n} else {\n    node.error(\"got back more than one daily value!\", msg);\n    return [null, null, null]\n}","outputs":3,"noerr":0,"x":1060,"y":180,"wires":[["a97f78e2.2b6518"],["cf16a2d0.ab4f6"],["9e917171.007cd"]]},{"id":"cf16a2d0.ab4f6","type":"mongodb out","z":"960d5a8b.8e7398","mongodb":"d159396.8c5adc8","name":"update daily doc","collection":"daily","payonly":false,"upsert":false,"multi":false,"operation":"update","x":1240,"y":180,"wires":[]},{"id":"a97f78e2.2b6518","type":"mongodb out","z":"960d5a8b.8e7398","mongodb":"d159396.8c5adc8","name":"new daily doc","collection":"daily","payonly":true,"upsert":false,"multi":false,"operation":"store","x":1240,"y":140,"wires":[]},{"id":"e7a29659.12ef58","type":"link out","z":"960d5a8b.8e7398","name":"water flow","links":["820ba66b.ca0938"],"x":680,"y":260,"wires":[],"l":true},{"id":"19a0b940.f26c87","type":"link in","z":"8f8f43f7.01481","name":"water daily","links":["9e917171.007cd"],"x":200,"y":180,"wires":[["3989bd20.f78b52"]],"l":true}]